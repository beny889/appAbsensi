// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum Role {
  ADMIN
  EMPLOYEE
}

enum AttendanceType {
  CHECK_IN
  CHECK_OUT
}

enum RegistrationStatus {
  PENDING
  APPROVED
  REJECTED
}

// Models
model User {
  id            String       @id @default(cuid())
  email         String?      @unique  // Only for ADMIN, nullable for EMPLOYEE
  password      String?                // Only for ADMIN, nullable for EMPLOYEE
  name          String
  role          Role         @default(EMPLOYEE)
  phone         String?
  position      String?
  departmentId  String?

  // Face recognition data (for EMPLOYEE only)
  faceEmbedding  String?      @db.Text  // Single embedding (legacy/backward compatibility)
  faceEmbeddings String?      @db.Text  // Multiple embeddings as JSON array for better accuracy
  faceImageUrl   String?

  // Status
  isActive      Boolean      @default(true)

  // Timestamps
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  attendances      Attendance[]
  faceRegistration FaceRegistration?
  department       Department?  @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  holidays         HolidayUser[]

  @@map("users")
  @@index([departmentId])
}

model Attendance {
  id              String         @id @default(cuid())
  userId          String
  type            AttendanceType

  // Face verification
  faceImageUrl    String?
  similarity      Float?         // Face match similarity score

  // Late/Early tracking
  isLate          Boolean?       // True if checked in late
  lateMinutes     Int?           // Minutes late (positive number)
  isEarlyCheckout Boolean?       // True if checked out early
  earlyMinutes    Int?           // Minutes early (positive number)
  scheduledTime   String?        // Scheduled time for this check (HH:MM)

  // Additional info
  notes           String?
  isVerified      Boolean        @default(true)

  // Timestamps
  timestamp       DateTime       @default(now())
  createdAt       DateTime       @default(now())

  // Relations
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("attendances")
  @@index([userId])
  @@index([timestamp])
}

model Settings {
  id                    String   @id @default(cuid())
  key                   String   @unique
  value                 String   @db.Text
  description           String?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("settings")
}

model FaceRegistration {
  id               String              @id @default(cuid())
  name             String
  faceEmbedding    String?             @db.Text  // Single embedding (legacy)
  faceEmbeddings   String?             @db.Text  // Multiple embeddings as JSON array
  faceImageUrl     String?
  status           RegistrationStatus  @default(PENDING)

  // Admin review
  reviewedBy      String?
  reviewedAt      DateTime?
  rejectionReason String?

  // Link to created user (if approved)
  userId          String?             @unique
  user            User?               @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@map("face_registrations")
  @@index([status])
  @@index([createdAt])
}

model Department {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users         User[]
  workSchedules WorkSchedule[]

  @@map("departments")
  @@index([name])
}

model WorkSchedule {
  id           String     @id @default(cuid())
  departmentId String
  checkInTime  String     // Format: "HH:MM" (e.g., "09:00")
  checkOutTime String     // Format: "HH:MM" (e.g., "17:00")
  isActive     Boolean    @default(true)

  // Timestamps
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@map("work_schedules")
  @@unique([departmentId]) // One schedule per department
  @@index([departmentId])
}

model Holiday {
  id          String   @id @default(cuid())
  date        DateTime @db.Date
  name        String
  description String?
  isGlobal    Boolean  @default(true)  // true = untuk semua karyawan, false = untuk karyawan tertentu

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users       HolidayUser[]

  @@map("holidays")
  @@index([date])
}

// Junction table for Holiday-User many-to-many relation
model HolidayUser {
  id        String   @id @default(cuid())
  holidayId String
  userId    String

  // Relations
  holiday   Holiday  @relation(fields: [holidayId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("holiday_users")
  @@unique([holidayId, userId])
  @@index([holidayId])
  @@index([userId])
}

// Face Match Attempt Log - records every face matching attempt (success or failure)
model FaceMatchAttempt {
  id                 String   @id @default(cuid())

  // Attempt info
  attemptType        String   // "CHECK_IN" | "CHECK_OUT"
  success            Boolean  // true if match found

  // Matched user (if success)
  matchedUserId      String?
  matchedUserName    String?

  // Matching details
  threshold          Float    // threshold used for matching
  bestDistance       Float?   // best distance found
  bestSimilarity     Float?   // best similarity percentage
  totalUsersCompared Int      // number of users compared

  // Detail of all comparisons (JSON array)
  allMatches         String   @db.Text

  // Timestamps
  createdAt          DateTime @default(now())

  @@map("face_match_attempts")
  @@index([createdAt])
  @@index([success])
}
