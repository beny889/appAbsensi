// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  SUPER_ADMIN    // Akses SEMUA cabang
  BRANCH_ADMIN   // Akses cabang tertentu saja
  ADMIN          // Legacy - treat as BRANCH_ADMIN
  EMPLOYEE
}

enum AttendanceType {
  CHECK_IN
  CHECK_OUT
}

enum RegistrationStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============= BRANCH MODEL =============
model Branch {
  id          String   @id @default(cuid())
  name        String   @unique
  code        String   @unique  // Kode singkat: "JKT", "SBY", "BDG"
  address     String?  @db.Text
  city        String?
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users             User[]
  departments       Department[]
  faceRegistrations FaceRegistration[]
  adminAccess       AdminBranchAccess[]
  deviceBindings    DeviceBinding[]
  holidays          Holiday[]
  faceMatchAttempts FaceMatchAttempt[]

  @@map("branches")
  @@index([code])
  @@index([isActive])
}

// ============= DEVICE BINDING (Kode Binding untuk Device) =============
model DeviceBinding {
  id          String    @id @default(cuid())
  code        String    @unique  // 5 uppercase letters: "ABCDE"
  branchId    String
  deviceName  String?   // Set when device uses the code
  isActive    Boolean   @default(true)
  usedAt      DateTime? // Timestamp when code was used
  createdBy   String    // User ID of admin who created

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  branch      Branch    @relation(fields: [branchId], references: [id], onDelete: Cascade)
  creator     User      @relation("BindingCreator", fields: [createdBy], references: [id])

  @@map("device_bindings")
  @@index([code])
  @@index([branchId])
  @@index([isActive])
}

// ============= ADMIN BRANCH ACCESS (Multi-branch admin) =============
model AdminBranchAccess {
  id        String   @id @default(cuid())
  userId    String
  branchId  String
  isDefault Boolean  @default(false)  // Default branch for viewing

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  branch    Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, branchId])
  @@map("admin_branch_access")
  @@index([userId])
  @@index([branchId])
}

// Models
model User {
  id            String       @id @default(cuid())
  email         String?      @unique  // Only for ADMIN, nullable for EMPLOYEE
  password      String?                // Only for ADMIN, nullable for EMPLOYEE
  name          String
  role          Role         @default(EMPLOYEE)
  phone         String?
  position      String?
  departmentId  String?
  branchId      String?      // Branch assignment

  // Face recognition data (for EMPLOYEE only)
  faceEmbedding  String?      @db.LongText  // Single embedding (legacy/backward compatibility)
  faceEmbeddings String?      @db.LongText  // Multiple embeddings as JSON array for better accuracy
  faceImageUrl   String?      @db.Text

  // Status
  isActive      Boolean      @default(true)

  // Admin permissions (JSON array of menu keys, null = all access for SUPER_ADMIN)
  allowedMenus  String?      @db.Text  // e.g. ["dashboard","employees","attendance"]
  defaultBranchId String?    // Default branch to view for BRANCH_ADMIN

  // Employment
  startDate     DateTime?    // Tanggal mulai bekerja

  // Timestamps
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  attendances       Attendance[]
  faceRegistration  FaceRegistration?
  department        Department?        @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  branch            Branch?            @relation(fields: [branchId], references: [id], onDelete: SetNull)
  holidays          HolidayUser[]
  adminBranchAccess AdminBranchAccess[]
  createdBindings   DeviceBinding[]    @relation("BindingCreator")

  @@map("users")
  @@index([departmentId])
  @@index([branchId])
}

model Attendance {
  id              String         @id @default(cuid())
  userId          String
  type            AttendanceType

  // Face verification
  faceImageUrl    String?        @db.Text
  similarity      Float?         // Face match similarity score

  // Late/Early tracking
  isLate          Boolean?       // True if checked in late
  lateMinutes     Int?           // Minutes late (positive number)
  isEarlyCheckout Boolean?       // True if checked out early
  earlyMinutes    Int?           // Minutes early (positive number)
  scheduledTime   String?        // Scheduled time for this check (HH:MM)

  // Additional info
  notes           String?
  isVerified      Boolean        @default(true)

  // Timestamps
  timestamp       DateTime       @default(now())
  createdAt       DateTime       @default(now())

  // Relations
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("attendances")
  @@index([userId])
  @@index([timestamp])
}

model Settings {
  id                    String   @id @default(cuid())
  key                   String   @unique
  value                 String   @db.LongText
  description           String?  @db.Text

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("settings")
}

model FaceRegistration {
  id               String              @id @default(cuid())
  name             String
  faceEmbedding    String?             @db.LongText  // Single embedding (legacy)
  faceEmbeddings   String?             @db.LongText  // Multiple embeddings as JSON array
  faceImageUrl     String?             @db.Text
  status           RegistrationStatus  @default(PENDING)
  branchId         String?             // Branch where registration was submitted

  // Admin review
  reviewedBy      String?
  reviewedAt      DateTime?
  rejectionReason String?             @db.Text

  // Link to created user (if approved)
  userId          String?             @unique
  user            User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  branch          Branch?             @relation(fields: [branchId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@map("face_registrations")
  @@index([status])
  @@index([createdAt])
  @@index([branchId])
}

model Department {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  branchId    String?  // Branch assignment
  isActive    Boolean  @default(true)

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users         User[]
  workSchedules WorkSchedule[]
  branch        Branch?  @relation(fields: [branchId], references: [id], onDelete: SetNull)

  @@map("departments")
  @@unique([name, branchId])  // Nama sama boleh di branch berbeda
  @@index([name])
  @@index([branchId])
}

model WorkSchedule {
  id           String     @id @default(cuid())
  departmentId String
  checkInTime  String     // Format: "HH:MM" (e.g., "09:00")
  checkOutTime String     // Format: "HH:MM" (e.g., "17:00")
  isActive     Boolean    @default(true)

  // Timestamps
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@map("work_schedules")
  @@unique([departmentId]) // One schedule per department
  @@index([departmentId])
}

model Holiday {
  id          String   @id @default(cuid())
  date        DateTime @db.Date
  name        String
  description String?  @db.Text
  isGlobal    Boolean  @default(true)  // true = untuk semua karyawan, false = untuk karyawan tertentu
  branchId    String?  // Branch assignment (null = all branches for SUPER_ADMIN view)

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users       HolidayUser[]
  branch      Branch?  @relation(fields: [branchId], references: [id], onDelete: SetNull)

  @@map("holidays")
  @@index([date])
  @@index([branchId])
}

// Junction table for Holiday-User many-to-many relation
model HolidayUser {
  id        String   @id @default(cuid())
  holidayId String
  userId    String

  // Relations
  holiday   Holiday  @relation(fields: [holidayId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("holiday_users")
  @@unique([holidayId, userId])
  @@index([holidayId])
  @@index([userId])
}

// Face Match Attempt Log - records every face matching attempt (success or failure)
model FaceMatchAttempt {
  id                 String   @id @default(cuid())

  // Attempt info
  attemptType        String   // "CHECK_IN" | "CHECK_OUT"
  success            Boolean  // true if match found
  branchId           String?  // Branch where attempt was made

  // Matched user (if success)
  matchedUserId      String?
  matchedUserName    String?

  // Matching details
  threshold          Float    // threshold used for matching
  bestDistance       Float?   // best distance found
  bestSimilarity     Float?   // best similarity percentage
  totalUsersCompared Int      // number of users compared

  // Detail of all comparisons (JSON array)
  allMatches         String   @db.LongText

  // Timestamps
  createdAt          DateTime @default(now())

  // Relations
  branch             Branch?  @relation(fields: [branchId], references: [id], onDelete: SetNull)

  @@map("face_match_attempts")
  @@index([createdAt])
  @@index([success])
  @@index([branchId])
}
