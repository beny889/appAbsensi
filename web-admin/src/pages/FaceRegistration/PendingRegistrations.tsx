import { useEffect, useState } from 'react';
import {
  Box,
  Paper,
  Typography,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Chip,
  CircularProgress,
  Button,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  Select,
  MenuItem,
  FormControl,
  InputLabel,
  Avatar,
  FormHelperText,
  Alert,
  AlertTitle,
} from '@mui/material';
import {
  CheckCircle as ApproveIcon,
  Cancel as RejectIcon,
  Delete as DeleteIcon,
  SwapHoriz as SwapIcon,
  Warning as WarningIcon,
} from '@mui/icons-material';
import { faceRegistrationApi, departmentApi, employeesApi, DuplicateCheckResult, authApi } from '@/api';
import { FaceRegistration, ApproveRegistrationDto, Department, Employee } from '@/types';
import { usePageTitle } from '@/contexts/PageTitleContext';
import { format } from 'date-fns';
import toast from 'react-hot-toast';

export default function PendingRegistrations() {
  const isSuperAdmin = authApi.getUserRole() === 'SUPER_ADMIN';
  const [registrations, setRegistrations] = useState<FaceRegistration[]>([]);
  const [departments, setDepartments] = useState<Department[]>([]);
  const [employees, setEmployees] = useState<Employee[]>([]);
  const [loading, setLoading] = useState(true);

  usePageTitle('Pendaftaran Wajah', 'Kelola pendaftaran wajah yang menunggu persetujuan');
  const [approveDialog, setApproveDialog] = useState<{ open: boolean; registration: FaceRegistration | null }>({
    open: false,
    registration: null,
  });
  const [rejectDialog, setRejectDialog] = useState<{ open: boolean; registration: FaceRegistration | null }>({
    open: false,
    registration: null,
  });
  const [replaceDialog, setReplaceDialog] = useState<{ open: boolean; registration: FaceRegistration | null }>({
    open: false,
    registration: null,
  });
  const [selectedUserId, setSelectedUserId] = useState('');

  const [approveData, setApproveData] = useState<ApproveRegistrationDto>({
    email: '',
    password: '',
    role: 'EMPLOYEE',
    position: '',
    departmentId: '',
    phone: '',
    startDate: new Date().toISOString().split('T')[0], // Default: today
  });

  const [rejectReason, setRejectReason] = useState('');
  const [submitting, setSubmitting] = useState(false);

  // Duplicate check state
  const [duplicateInfo, setDuplicateInfo] = useState<DuplicateCheckResult | null>(null);
  const [checkingDuplicate, setCheckingDuplicate] = useState(false);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      setLoading(true);
      const [registrationsData, departmentsData, employeesData] = await Promise.all([
        faceRegistrationApi.getPending(),
        departmentApi.getAll(),
        employeesApi.getAll(),
      ]);
      setRegistrations(registrationsData);
      setDepartments(departmentsData.filter(d => d.isActive));
      setEmployees(employeesData.filter(e => e.isActive));
    } catch (error) {
      toast.error('Gagal memuat data');
    } finally {
      setLoading(false);
    }
  };

  const loadPendingRegistrations = async () => {
    try {
      setLoading(true);
      const data = await faceRegistrationApi.getPending();
      setRegistrations(data);
    } catch (error) {
      toast.error('Gagal memuat data pendaftaran');
    } finally {
      setLoading(false);
    }
  };

  const handleApproveClick = async (registration: FaceRegistration) => {
    // Reset states
    setDuplicateInfo(null);
    setApproveData({
      email: '',
      password: '',
      role: 'EMPLOYEE',
      position: '',
      departmentId: '',
      phone: '',
      startDate: new Date().toISOString().split('T')[0], // Default: today
    });

    // Open dialog first
    setApproveDialog({ open: true, registration });

    // Check for duplicate in background
    setCheckingDuplicate(true);
    try {
      const result = await faceRegistrationApi.checkDuplicate(registration.id);
      setDuplicateInfo(result.duplicateCheck);
    } catch (error) {
      // Ignore error, proceed without duplicate check
      console.error('Failed to check duplicate:', error);
    } finally {
      setCheckingDuplicate(false);
    }
  };

  const handleRejectClick = (registration: FaceRegistration) => {
    setRejectDialog({ open: true, registration });
    setRejectReason('');
  };

  const handleApprove = async () => {
    if (!approveDialog.registration) return;

    // Validate departmentId is required
    if (!approveData.departmentId || !approveData.departmentId.trim()) {
      toast.error('Departemen harus dipilih');
      return;
    }

    try {
      setSubmitting(true);
      // Send role, departmentId, and startDate (email & password will be auto-generated by backend)
      const dataToSend: any = {
        role: approveData.role || 'EMPLOYEE',
        departmentId: approveData.departmentId.trim(),
        startDate: approveData.startDate,
      };

      await faceRegistrationApi.approve(approveDialog.registration.id, dataToSend);
      toast.success('Pendaftaran berhasil disetujui dan akun dibuat');
      setApproveDialog({ open: false, registration: null });
      loadPendingRegistrations();
    } catch (error) {
    } finally {
      setSubmitting(false);
    }
  };

  const handleReject = async () => {
    if (!rejectDialog.registration) return;

    if (!rejectReason || rejectReason.length < 10) {
      toast.error('Alasan penolakan minimal 10 karakter');
      return;
    }

    try {
      setSubmitting(true);
      await faceRegistrationApi.reject(rejectDialog.registration.id, { reason: rejectReason });
      toast.success('Pendaftaran berhasil ditolak');
      setRejectDialog({ open: false, registration: null });
      loadPendingRegistrations();
    } catch (error) {
    } finally {
      setSubmitting(false);
    }
  };

  const handleDelete = async (id: string, name: string) => {
    if (!confirm(`Hapus pendaftaran dari ${name}?`)) return;

    try {
      await faceRegistrationApi.delete(id);
      toast.success('Pendaftaran berhasil dihapus');
      loadPendingRegistrations();
    } catch (error) {
    }
  };

  const handleReplaceClick = (registration: FaceRegistration) => {
    setReplaceDialog({ open: true, registration });
    setSelectedUserId('');
  };

  const handleReplaceFace = async () => {
    if (!replaceDialog.registration) return;

    if (!selectedUserId) {
      toast.error('Pilih karyawan terlebih dahulu');
      return;
    }

    try {
      setSubmitting(true);
      await faceRegistrationApi.replaceFace(replaceDialog.registration.id, selectedUserId);
      toast.success('Wajah karyawan berhasil diganti');
      setReplaceDialog({ open: false, registration: null });
      loadPendingRegistrations();
    } catch (error) {
    } finally {
      setSubmitting(false);
    }
  };

  const selectedEmployee = employees.find(e => e.id === selectedUserId);

  if (loading) {
    return (
      <Box display="flex" justifyContent="center" alignItems="center" minHeight="400px">
        <CircularProgress />
      </Box>
    );
  }

  return (
    <Box>
      <TableContainer component={Paper}>
        <Table>
          <TableHead>
            <TableRow>
              <TableCell align="center" sx={{ width: 60 }}><strong>No</strong></TableCell>
              <TableCell><strong>Foto</strong></TableCell>
              <TableCell><strong>Nama</strong></TableCell>
              {isSuperAdmin && <TableCell><strong>Cabang</strong></TableCell>}
              <TableCell><strong>Status</strong></TableCell>
              <TableCell><strong>Tanggal Daftar</strong></TableCell>
              <TableCell align="center"><strong>Aksi</strong></TableCell>
            </TableRow>
          </TableHead>
          <TableBody>
            {registrations.length === 0 ? (
              <TableRow>
                <TableCell colSpan={isSuperAdmin ? 7 : 6} align="center">
                  <Typography variant="body2" color="textSecondary" sx={{ py: 4 }}>
                    Tidak ada pendaftaran yang menunggu persetujuan
                  </Typography>
                </TableCell>
              </TableRow>
            ) : (
              registrations.map((registration, index) => (
                <TableRow key={registration.id} hover>
                  <TableCell align="center">
                    <Typography variant="body2" color="text.secondary">
                      {index + 1}
                    </Typography>
                  </TableCell>
                  <TableCell>
                    <Avatar
                      src={registration.faceImageUrl}
                      alt={registration.name}
                      sx={{ width: 50, height: 50 }}
                    >
                      {registration.name.charAt(0).toUpperCase()}
                    </Avatar>
                  </TableCell>
                  <TableCell>{registration.name}</TableCell>
                  {isSuperAdmin && (
                    <TableCell>
                      <Typography variant="body2">
                        {registration.branch?.name || '-'}
                      </Typography>
                    </TableCell>
                  )}
                  <TableCell>
                    <Chip
                      label={registration.status}
                      color="warning"
                      size="small"
                    />
                  </TableCell>
                  <TableCell>
                    {format(new Date(registration.createdAt), 'dd MMM yyyy HH:mm')}
                  </TableCell>
                  <TableCell align="center">
                    <Box sx={{ display: 'flex', gap: 1, justifyContent: 'center', flexWrap: 'wrap' }}>
                      <Button
                        size="small"
                        variant="contained"
                        color="success"
                        startIcon={<ApproveIcon />}
                        onClick={() => handleApproveClick(registration)}
                      >
                        Setuju
                      </Button>
                      <Button
                        size="small"
                        variant="contained"
                        color="info"
                        startIcon={<SwapIcon />}
                        onClick={() => handleReplaceClick(registration)}
                      >
                        Ganti Wajah
                      </Button>
                      <Button
                        size="small"
                        variant="contained"
                        color="error"
                        startIcon={<RejectIcon />}
                        onClick={() => handleRejectClick(registration)}
                      >
                        Tolak
                      </Button>
                      <Button
                        size="small"
                        variant="outlined"
                        color="error"
                        startIcon={<DeleteIcon />}
                        onClick={() => handleDelete(registration.id, registration.name)}
                      >
                        Hapus
                      </Button>
                    </Box>
                  </TableCell>
                </TableRow>
              ))
            )}
          </TableBody>
        </Table>
      </TableContainer>

      <Box sx={{ mt: 2 }}>
        <Typography variant="body2" color="textSecondary">
          Total: {registrations.length} pendaftaran menunggu
        </Typography>
      </Box>

      {/* Approve Dialog */}
      <Dialog open={approveDialog.open} onClose={() => setApproveDialog({ open: false, registration: null })} maxWidth="sm" fullWidth>
        <DialogTitle>Setujui Pendaftaran</DialogTitle>
        <DialogContent>
          <Typography variant="body2" color="textSecondary" sx={{ mb: 1 }}>
            Buat akun untuk: <strong>{approveDialog.registration?.name}</strong>
          </Typography>

          {/* Duplicate Warning */}
          {checkingDuplicate && (
            <Alert severity="info" sx={{ mb: 2 }}>
              <CircularProgress size={16} sx={{ mr: 1 }} />
              Memeriksa kesamaan wajah...
            </Alert>
          )}

          {!checkingDuplicate && duplicateInfo?.isDuplicate && (
            <Alert severity="warning" sx={{ mb: 2 }} icon={<WarningIcon />}>
              <AlertTitle>Wajah Mirip Terdeteksi!</AlertTitle>
              <Typography variant="body2" sx={{ mb: 1 }}>
                Wajah ini mirip dengan karyawan yang sudah terdaftar:
              </Typography>
              <Box sx={{ mt: 1 }}>
                {duplicateInfo.matchedUsers.map((user) => (
                  <Box key={user.id} sx={{ display: 'flex', alignItems: 'center', gap: 1, mt: 1, p: 1, bgcolor: 'warning.lighter', borderRadius: 1 }}>
                    <Avatar src={user.faceImageUrl || undefined} sx={{ width: 40, height: 40 }}>
                      {user.name.charAt(0).toUpperCase()}
                    </Avatar>
                    <Box>
                      <Typography variant="body2" fontWeight="bold">{user.name}</Typography>
                      <Typography variant="caption" color="error.main" fontWeight="bold">
                        Kemiripan: {user.similarity}%
                      </Typography>
                    </Box>
                  </Box>
                ))}
              </Box>
              <Typography variant="caption" sx={{ mt: 1, display: 'block', fontStyle: 'italic' }}>
                Anda tetap dapat menyetujui jika yakin ini adalah orang yang berbeda.
              </Typography>
            </Alert>
          )}

          <Typography variant="caption" color="info.main" sx={{ mb: 3, display: 'block', p: 1.5, bgcolor: 'info.lighter', borderRadius: 1 }}>
            ℹ️ Email dan password akan otomatis di-generate oleh sistem
          </Typography>

          <FormControl fullWidth sx={{ mb: 2 }}>
            <InputLabel>Role</InputLabel>
            <Select
              value={approveData.role}
              label="Role"
              onChange={(e) => setApproveData({ ...approveData, role: e.target.value as 'ADMIN' | 'EMPLOYEE' })}
            >
              <MenuItem value="EMPLOYEE">Employee</MenuItem>
              <MenuItem value="ADMIN">Admin</MenuItem>
            </Select>
          </FormControl>

          <FormControl fullWidth required error={!approveData.departmentId && departments.length > 0}>
            <InputLabel>Departemen</InputLabel>
            <Select
              value={approveData.departmentId}
              label="Departemen"
              onChange={(e) => setApproveData({ ...approveData, departmentId: e.target.value })}
            >
              {departments.map((dept) => (
                <MenuItem key={dept.id} value={dept.id}>
                  {dept.name}
                </MenuItem>
              ))}
            </Select>
            {departments.length === 0 && (
              <FormHelperText error>
                Belum ada departemen aktif. Silakan tambahkan departemen terlebih dahulu.
              </FormHelperText>
            )}
          </FormControl>

          <TextField
            label="Tanggal Mulai Bekerja"
            type="date"
            fullWidth
            required
            value={approveData.startDate}
            onChange={(e) => setApproveData({ ...approveData, startDate: e.target.value })}
            InputLabelProps={{ shrink: true }}
            sx={{ mt: 2 }}
          />
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setApproveDialog({ open: false, registration: null })} disabled={submitting}>
            Batal
          </Button>
          <Button onClick={handleApprove} variant="contained" color="success" disabled={submitting || departments.length === 0}>
            {submitting ? 'Memproses...' : 'Setujui & Buat Akun'}
          </Button>
        </DialogActions>
      </Dialog>

      {/* Reject Dialog */}
      <Dialog open={rejectDialog.open} onClose={() => setRejectDialog({ open: false, registration: null })} maxWidth="sm" fullWidth>
        <DialogTitle>Tolak Pendaftaran</DialogTitle>
        <DialogContent>
          <Typography variant="body2" color="textSecondary" sx={{ mb: 2 }}>
            Berikan alasan penolakan untuk: <strong>{rejectDialog.registration?.name}</strong>
          </Typography>

          <TextField
            fullWidth
            label="Alasan Penolakan"
            multiline
            rows={4}
            value={rejectReason}
            onChange={(e) => setRejectReason(e.target.value)}
            helperText="Minimal 10 karakter"
            required
            sx={{ mt: 1 }}
          />
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setRejectDialog({ open: false, registration: null })} disabled={submitting}>
            Batal
          </Button>
          <Button onClick={handleReject} variant="contained" color="error" disabled={submitting}>
            {submitting ? 'Memproses...' : 'Tolak Pendaftaran'}
          </Button>
        </DialogActions>
      </Dialog>

      {/* Replace Face Dialog */}
      <Dialog open={replaceDialog.open} onClose={() => setReplaceDialog({ open: false, registration: null })} maxWidth="sm" fullWidth>
        <DialogTitle>Ganti Wajah Karyawan</DialogTitle>
        <DialogContent>
          <Typography variant="body2" color="textSecondary" sx={{ mb: 2 }}>
            Gunakan wajah dari: <strong>{replaceDialog.registration?.name}</strong>
          </Typography>

          {/* Photo comparison */}
          <Box sx={{ display: 'flex', justifyContent: 'center', gap: 4, mb: 3 }}>
            <Box sx={{ textAlign: 'center' }}>
              <Avatar
                src={replaceDialog.registration?.faceImageUrl}
                alt="Foto Baru"
                sx={{ width: 80, height: 80, mx: 'auto', mb: 1 }}
              />
              <Typography variant="caption" color="textSecondary">Foto Baru</Typography>
            </Box>
            <Box sx={{ display: 'flex', alignItems: 'center' }}>
              <SwapIcon color="action" />
            </Box>
            <Box sx={{ textAlign: 'center' }}>
              <Avatar
                src={selectedEmployee?.faceImageUrl}
                alt="Foto Lama"
                sx={{ width: 80, height: 80, mx: 'auto', mb: 1, bgcolor: 'grey.300' }}
              >
                {selectedEmployee?.name?.charAt(0).toUpperCase() || '?'}
              </Avatar>
              <Typography variant="caption" color="textSecondary">
                {selectedEmployee ? 'Foto Lama' : 'Pilih Karyawan'}
              </Typography>
            </Box>
          </Box>

          <FormControl fullWidth required error={!selectedUserId && employees.length > 0}>
            <InputLabel>Pilih Karyawan</InputLabel>
            <Select
              value={selectedUserId}
              label="Pilih Karyawan"
              onChange={(e) => setSelectedUserId(e.target.value)}
            >
              {employees.map((emp) => (
                <MenuItem key={emp.id} value={emp.id}>
                  {emp.name} {emp.department?.name ? `(${emp.department.name})` : ''}
                </MenuItem>
              ))}
            </Select>
            {employees.length === 0 && (
              <FormHelperText error>
                Belum ada karyawan aktif.
              </FormHelperText>
            )}
          </FormControl>

          <Typography variant="caption" color="warning.main" sx={{ mt: 2, display: 'block', p: 1.5, bgcolor: 'warning.lighter', borderRadius: 1 }}>
            Data wajah lama karyawan akan diganti dengan wajah baru. Riwayat absensi tidak akan terpengaruh.
          </Typography>
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setReplaceDialog({ open: false, registration: null })} disabled={submitting}>
            Batal
          </Button>
          <Button onClick={handleReplaceFace} variant="contained" color="info" disabled={submitting || !selectedUserId}>
            {submitting ? 'Memproses...' : 'Ganti Wajah'}
          </Button>
        </DialogActions>
      </Dialog>
    </Box>
  );
}
